# 播客处理系统稳定性改进方案

## 问题诊断

### 1. 数据库连接问题
- **现象**: `Can't reach database server`, `Error { kind: Closed, cause: None }`
- **影响**: TaskQueue初始化失败，任务无法正常处理
- **根本原因**: Supabase数据库连接不稳定，连接池超时

### 2. ASR服务超时
- **现象**: `Response timeout for 60000ms`
- **影响**: 音频转写失败，整个处理流程中断
- **根本原因**: 长音频文件处理时间超过60秒超时限制

### 3. 任务处理不稳定
- **现象**: 任务卡在processing状态，进度条显示不准确
- **影响**: 用户看到100%但实际未完成，或者任务失败但状态未更新
- **根本原因**: 缺少重试机制和错误恢复能力

## 已实施的改进

### 1. TaskQueue重试机制（src/server/task-queue.ts）
```typescript
- 添加重试次数记录（retryAttempts Map）
- 最大重试次数: 3次
- 重试延迟: 5秒
- 数据库连接重试延迟: 10秒
```

**关键改进**:
- 检测数据库连接错误时自动重新初始化
- 任务失败时根据错误类型决定是否重试
- 超过最大重试次数后才标记为失败

### 2. 数据库健康检查（src/utils/db-health.ts）
```typescript
- 定期健康检查（每30秒）
- 连接状态监控
- 强制重新连接能力
- 等待连接恢复机制
```

**核心功能**:
- `checkHealth()`: 执行SELECT 1测试连接
- `waitForConnection()`: 等待连接恢复（最多60秒）
- `forceReconnect()`: 强制断开并重新连接

### 3. 进度追踪改进（src/components/SimpleProcessingStatus.tsx）
```typescript
- 主动轮询后端任务状态
- 运行超过10分钟或进度达到95%时强制检查
- 清理僵尸任务（超过30分钟未完成）
```

## 稳定性提升建议

### 立即执行的改进

#### 1. 增加数据库连接池大小
**文件**: `prisma/schema.prisma`
```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  connection_limit = 20  // 增加连接池大小
}
```

#### 2. 实施断路器模式
当数据库连接频繁失败时，暂停新任务提交，避免雪崩效应。

#### 3. 添加任务优先级
紧急任务优先处理，长音频任务降低优先级。

### 中期改进方案

#### 1. 引入消息队列（Redis/BullMQ）
- 替代当前的数据库队列
- 提供更好的持久化和重试能力
- 减少数据库压力

#### 2. 分离ASR处理
- 使用独立的ASR服务
- 支持更长的超时时间
- 异步回调机制

#### 3. 添加监控和告警
- 数据库连接状态监控
- 任务处理时长告警
- 失败率统计

### 长期优化方案

#### 1. 微服务架构
- 分离音频下载服务
- 分离ASR转写服务
- 分离LLM处理服务

#### 2. 使用CDN加速
- 音频文件下载加速
- 减少下载超时

#### 3. 智能重试策略
- 根据错误类型调整重试间隔
- 指数退避算法
- 熔断机制

## 当前问题的处理流程

### 对于卡住的播客（如: 68f1727052f01d1dd2a00523）

1. **检查任务状态**:
```bash
node -e "
const { PrismaClient } = require('@prisma/client');
const db = new PrismaClient();
db.taskQueue.findMany({ 
  where: { 
    data: { path: ['url'], string_contains: '68f1727052f01d1dd2a00523' }
  }
}).then(console.log).finally(() => db.\$disconnect());
"
```

2. **重新处理**:
- 在管理后台删除该播客
- 重新提交链接进行处理

3. **监控处理过程**:
- 观察终端日志
- 检查数据库连接状态
- 确认ASR服务响应

## 运维建议

### 日常维护
1. **定期重启应用**（每周）- 清理连接池
2. **监控数据库连接数** - 避免连接池耗尽
3. **清理失败任务** - 避免队列堆积

### 故障处理
1. **数据库连接失败**:
   - 检查Supabase服务状态
   - 重启应用重新建立连接
   
2. **ASR服务超时**:
   - 检查音频文件大小和时长
   - 考虑分段处理长音频
   
3. **任务卡住**:
   - 查看TaskQueue状态
   - 手动标记为失败并重试

## 性能指标

### 目标
- 数据库连接成功率: >99%
- 任务处理成功率: >95%
- 平均处理时间: 音频时长 × 0.2（1小时音频12分钟内完成）
- 最大处理时间: 音频时长 × 0.5（1小时音频30分钟内完成）

### 当前状态
- 数据库连接: 不稳定，需要改进
- 任务成功率: 约80-85%（受连接问题影响）
- 处理时间: 1小时音频约15-30分钟（波动较大）

## 下一步行动

1. ✅ 实施TaskQueue重试机制
2. ✅ 添加数据库健康检查
3. ⏳ 测试并验证改进效果
4. ⏳ 优化数据库连接配置
5. ⏳ 添加监控和告警系统
6. ⏳ 考虑引入Redis队列

